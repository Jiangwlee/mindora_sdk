# Mindora SDK åŸºç¡€è®¾æ–½ Nginx ä¸»é…ç½®æ–‡ä»¶
# æä¾›ç»Ÿä¸€çš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

# ä¼˜åŒ–workerè¿›ç¨‹é…ç½®
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
}

http {
    # åŸºç¡€é…ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for" '
                    'rt=$request_time uct="$upstream_connect_time" '
                    'uht="$upstream_header_time" urt="$upstream_response_time"';

    # JSONæ ¼å¼æ—¥å¿—ï¼ˆç”¨äºæ—¥å¿—åˆ†æï¼‰
    log_format json_analytics escape=json '{'
                                '"time": "$time_iso8601",'
                                '"remote_addr": "$remote_addr",'
                                '"remote_user": "$remote_user",'
                                '"request": "$request",'
                                '"status": $status,'
                                '"body_bytes_sent": $body_bytes_sent,'
                                '"request_time": $request_time,'
                                '"upstream_response_time": "$upstream_response_time",'
                                '"upstream_connect_time": "$upstream_connect_time",'
                                '"upstream_header_time": "$upstream_header_time",'
                                '"http_referrer": "$http_referer",'
                                '"http_user_agent": "$http_user_agent",'
                                '"http_x_forwarded_for": "$http_x_forwarded_for"'
                            '}';

    access_log /var/log/nginx/access.log main;

    # æ€§èƒ½ä¼˜åŒ–
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    server_tokens off;

    # ç¼“å†²åŒºè®¾ç½®
    client_body_buffer_size 128k;
    client_max_body_size 100m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    output_buffers 1 32k;
    postpone_output 1460;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;

    # SSLé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ä¸Šæ¸¸æœåŠ¡å®šä¹‰
    upstream grafana {
        server grafana:3000;
        keepalive 32;
    }

    upstream prometheus {
        server prometheus:9090;
        keepalive 32;
    }

    upstream kibana {
        server kibana:5601;
        keepalive 32;
    }

    upstream consul {
        server consul:8500;
        keepalive 32;
    }

    upstream minio_api {
        server minio:9000;
        keepalive 32;
    }

    upstream minio_console {
        server minio:9001;
        keepalive 32;
    }

    upstream elasticsearch {
        server elasticsearch:9200;
        keepalive 32;
    }

    upstream qdrant {
        server qdrant:6333;
        keepalive 32;
    }

    upstream rabbitmq {
        server rabbitmq:15672;
        keepalive 32;
    }

    # é™åˆ¶è¯·æ±‚é¢‘ç‡
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=management:10m rate=5r/s;

    # é»˜è®¤æœåŠ¡å™¨é…ç½®
    server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }

    # ä¸»è¦HTTPSæœåŠ¡å™¨
    server {
        listen 443 ssl http2;
        server_name mindora.local localhost;

        # SSLè¯ä¹¦é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦çœŸå®è¯ä¹¦ï¼‰
        ssl_certificate /etc/nginx/ssl/mindora.crt;
        ssl_certificate_key /etc/nginx/ssl/mindora.key;

        # å®‰å…¨å¤´è®¾ç½®
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # æ ¹è·¯å¾„ - æ˜¾ç¤ºæœåŠ¡å¯¼èˆªé¡µé¢
        location / {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Mindora Infrastructure Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; margin-bottom: 40px; }
        .services { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .service { padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #fff; }
        .service h3 { margin-top: 0; color: #2c5aa0; }
        .service a { color: #007bff; text-decoration: none; }
        .service a:hover { text-decoration: underline; }
        .status { display: inline-block; padding: 2px 8px; border-radius: 3px; color: white; font-size: 12px; }
        .status.running { background: #28a745; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ Mindora Infrastructure Dashboard</h1>
        <div class="services">
            <div class="service">
                <h3>ğŸ“Š Grafana <span class="status running">RUNNING</span></h3>
                <p>ç›‘æ§å’Œå¯è§†åŒ–ä»ªè¡¨æ¿</p>
                <a href="/grafana/" target="_blank">è®¿é—® Grafana â†’</a>
            </div>
            <div class="service">
                <h3>ğŸ” Kibana <span class="status running">RUNNING</span></h3>
                <p>æ—¥å¿—åˆ†æå’Œæœç´¢</p>
                <a href="/kibana/" target="_blank">è®¿é—® Kibana â†’</a>
            </div>
            <div class="service">
                <h3>ğŸ”§ Consul <span class="status running">RUNNING</span></h3>
                <p>æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†</p>
                <a href="/consul/" target="_blank">è®¿é—® Consul â†’</a>
            </div>
            <div class="service">
                <h3>ğŸ“ˆ Prometheus <span class="status running">RUNNING</span></h3>
                <p>æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§</p>
                <a href="/prometheus/" target="_blank">è®¿é—® Prometheus â†’</a>
            </div>
            <div class="service">
                <h3>ğŸ—„ï¸ MinIO Console <span class="status running">RUNNING</span></h3>
                <p>å¯¹è±¡å­˜å‚¨ç®¡ç†æ§åˆ¶å°</p>
                <a href="/minio/" target="_blank">è®¿é—® MinIO Console â†’</a>
            </div>
            <div class="service">
                <h3>ğŸ° RabbitMQ <span class="status running">RUNNING</span></h3>
                <p>æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç†</p>
                <a href="/rabbitmq/" target="_blank">è®¿é—® RabbitMQ Management â†’</a>
            </div>
        </div>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Grafana ç›‘æ§ä»ªè¡¨æ¿
        location /grafana/ {
            limit_req zone=management burst=20 nodelay;
            
            proxy_pass http://grafana/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocketæ”¯æŒ
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            proxy_buffering off;
            proxy_cache_bypass $http_upgrade;
        }

        # Prometheus ç›‘æ§æ•°æ®
        location /prometheus/ {
            limit_req zone=api burst=50 nodelay;
            
            proxy_pass http://prometheus/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Kibana æ—¥å¿—åˆ†æ
        location /kibana/ {
            limit_req zone=management burst=20 nodelay;
            
            proxy_pass http://kibana/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_buffering off;
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
        }

        # Consul æœåŠ¡å‘ç°
        location /consul/ {
            limit_req zone=management burst=10 nodelay;
            
            proxy_pass http://consul/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # MinIO Console
        location /minio/ {
            limit_req zone=management burst=10 nodelay;
            
            proxy_pass http://minio_console/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # MinIO Consoleéœ€è¦çš„ç‰¹æ®Šå¤´
            proxy_set_header X-NginX-Proxy true;
            proxy_ssl_session_reuse off;
            proxy_redirect off;
        }

        # RabbitMQ Management
        location /rabbitmq/ {
            limit_req zone=management burst=10 nodelay;
            
            proxy_pass http://rabbitmq/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # APIç«¯ç‚¹è·¯ç”±
        location /api/ {
            limit_req zone=api burst=100 nodelay;
            
            # æ ¹æ®APIè·¯å¾„è·¯ç”±åˆ°ä¸åŒæœåŠ¡
            location /api/storage/ {
                proxy_pass http://minio_api/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            location /api/search/ {
                proxy_pass http://elasticsearch/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
            
            location /api/vector/ {
                proxy_pass http://qdrant/;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }
        }

        # å¥åº·æ£€æŸ¥ç«¯ç‚¹
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # é™æ€æ–‡ä»¶ç¼“å­˜
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
        }
    }

    # åŒ…å«é¢å¤–çš„é…ç½®æ–‡ä»¶
    include /etc/nginx/conf.d/*.conf;
}